<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Commerce Homepage</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.7/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const API_BASE_URL = 'https://shoppica-backend.onrender.com/api';
    const IMAGE_BASE_URL = 'https://shoppica-backend.onrender.com/static/';

    const Homepage = () => {
      const [products, setProducts] = useState([]);
      const [categories, setCategories] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      // Fetch products and their discounts
      const fetchProducts = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/products?page=1&per_page=8`);
          const data = await response.json();
          if (response.ok) {
            // Fetch discounts for each product
            const productsWithDiscounts = await Promise.all(
              data.products.map(async (product) => {
                const discountResponse = await fetch(`${API_BASE_URL}/product_discounts/valid/${product.id}`);
                const discountData = await discountResponse.json();
                return {
                  ...product,
                  discount: discountData.product_discounts[0]?.discount_percent || null,
                  // تحويل image_url إلى رابط كامل
                  image_url: product.image_url ? `${IMAGE_BASE_URL}${product.image_url}` : 'https://via.placeholder.com/150',
                };
              })
            );
            setProducts(productsWithDiscounts);
          } else {
            setError(data.error || 'Failed to fetch products');
          }
        } catch (err) {
          setError('Network error');
        }
      };

      // Fetch top-level categories and their discounts
      const fetchCategories = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/categories/parent`);
          const data = await response.json();
          if (response.ok) {
            // Fetch discounts for each category
            const categoriesWithDiscounts = await Promise.all(
              data.categories.map(async (category) => {
                const discountResponse = await fetch(`${API_BASE_URL}/category_discounts/valid/${category.id}`);
                const discountData = await discountResponse.json();
                return {
                  ...category,
                  discount: discountData.category_discounts[0]?.discount_percent || null,
                };
              })
            );
            setCategories(categoriesWithDiscounts);
          } else {
            setError(data.error || 'Failed to fetch categories');
          }
        } catch (err) {
          setError('Network error');
        }
      };

      useEffect(() => {
        Promise.all([fetchProducts(), fetchCategories()])
          .then(() => setLoading(false))
          .catch(() => setError('Failed to load data'));
      }, []);

      if (loading) return <div className="text-center py-10">Loading...</div>;
      if (error) return <div className="text-center py-10 text-red-500">{error}</div>;

      return (
        <div className="min-h-screen bg-gray-100">
          {/* Header */}
          <header className="bg-blue-600 text-white py-4">
            <div className="container mx-auto flex justify-between items-center px-4">
              <h1 className="text-2xl font-bold">Shoppica</h1>
              <nav className="space-x-4">
                <a href="/login" className="hover:underline">Login/Register</a>
                <a href="/cart" className="hover:underline">Cart</a>
              </nav>
            </div>
          </header>

          {/* Hero Section */}
          <section className="bg-blue-500 text-white py-20 text-center">
            <div className="container mx-auto">
              <h2 className="text-4xl font-bold mb-4">Welcome to Shoppica</h2>
              <p className="text-lg mb-6">Discover amazing products and unbeatable deals!</p>
              <a
                href="/products"
                className="bg-white text-blue-600 px-6 py-3 rounded-full font-semibold hover:bg-gray-200"
              >
                Shop Now
              </a>
            </div>
          </section>

          {/* Featured Products */}
          <section className="py-10">
            <div className="container mx-auto px-4">
              <h3 className="text-3xl font-bold mb-6">Featured Products</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                {products.map((product) => (
                  <div key={product.id} className="bg-white rounded-lg shadow-md overflow-hidden">
                    <img
                      src={product.image_url}
                      alt={product.name}
                      className="w-full h-48 object-cover"
                      onError={(e) => { e.target.src = 'https://via.placeholder.com/150'; }}
                    />
                    <div className="p-4">
                      <h4 className="text-lg font-semibold">{product.name}</h4>
                      <p className="text-gray-600 truncate">{product.description}</p>
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-lg font-bold">
                          ${product.discount
                            ? (product.price * (1 - product.discount / 100)).toFixed(2)
                            : product.price.toFixed(2)}
                          {product.discount && (
                            <span className="text-sm text-red-500 ml-2">(-{product.discount}%)</span>
                          )}
                        </span>
                      </div>
                      <a
                        href={`/product/${product.id}`}
                        className="block mt-4 bg-blue-600 text-white text-center py-2 rounded hover:bg-blue-700"
                      >
                        View Details
                      </a>
                    </div>
                  </div>
                ))}
              </div>
              <div className="text-center mt-8">
                <a
                  href="/products"
                  className="text-blue-600 font-semibold hover:underline"
                >
                  View All Products
                </a>
              </div>
            </div>
          </section>

          {/* Categories */}
          <section className="py-10 bg-gray-200">
            <div className="container mx-auto px-4">
              <h3 className="text-3xl font-bold mb-6">Shop by Category</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                {categories.map((category) => (
                  <div key={category.id} className="bg-white rounded-lg shadow-md p-6 text-center">
                    <h4 className="text-lg font-semibold">{category.name}</h4>
                    {category.discount && (
                      <p className="text-red-500">Up to {category.discount}% Off</p>
                    )}
                    <a
                      href={`/category/${category.id}`}
                      className="block mt-4 text-blue-600 font-semibold hover:underline"
                    >
                      Browse {category.name}
                    </a>
                  </div>
                ))}
              </div>
              <div className="text-center mt-8">
                <a
                  href="/categories"
                  className="text-blue-600 font-semibold hover:underline"
                >
                  View All Categories
                </a>
              </div>
            </div>
          </section>

          {/* Footer */}
          <footer className="bg-gray-800 text-white py-6">
            <div className="container mx-auto text-center">
              <p>© 2025 Shoppica. All rights reserved.</p>
            </div>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<Homepage />, document.getElementById('root'));
  </script>
</body>
</html>